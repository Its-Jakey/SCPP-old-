#include <cloud>
#include <graphics>
#include <strings>
#include <input>
#include <math>

#define ROWS 32
#define COLS 55


namespace messenger {
    var texts[ROWS];
    var rowIdx = 0;
    var isSending = 0;
    var channel = 0;
    var lasts[10];

    func addText(text) {
        texts[rowIdx] = text;
        rowIdx += math::round(strings::sizeOf(text) / COLS, 0) + 1;
    }

    func update() {
        graphics::clear();

        for (i from 0 to rowIdx)
            graphics::drawTextLine(texts[i]);
        graphics::flip();
    }


    public func main() {

        while (1) {
            if (isSending) {
                var toSend = input::ask("Message:");
                addText(strings::join("you: ", toSend));

                lasts[channel] = cloud::encode(toSend);
                println(lasts[channel]);
                cloud::setVar(channel, lasts[channel]);
                isSending = 0;
            }
            if (input::isKeyPressed("space"))
                isSending = 1;

            if (cloud::getVar(channel) != lasts[channel]) {
                lasts[channel] = cloud::getVar(channel);

                var message = strings::join("other: ", cloud::decode(lasts[channel]));
                addText(message);
            }
            update();
        }
    }

}
